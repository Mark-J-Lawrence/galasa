pipeline {

   agent {
      label 'codesigning'
   }

   environment {
      // Configure Gradle from the tools definition in Jenkins
      def gradleHome = tool 'gradle'
      PATH = "${gradleHome}/bin:${env.PATH}"
      
      //Set some defaults
      def workspace = pwd()
   }

   stages {
      stage('prep-workspace') { 
         steps {
            configFileProvider([configFile(fileId: 'galasa-init-gradle', targetLocation: '.gradle/init.gradle'),
                                configFile(fileId: 'galasa-gradle-properties', targetLocation: '.gradle/gradle.properties')]) {
            }
         }
      }

      stage('gradle') {
         steps {
            withCredentials([
               usernamePassword(credentialsId: 'galasa-nexus', usernameVariable: 'MAVENUSERNAME', passwordVariable: 'MAVENPASSWORD'),
               usernamePassword(credentialsId: 'gradle-cache', usernameVariable: 'CACHEUSERNAME', passwordVariable: 'CACHEPASSWORD')
            ]) {
               withFolderProperties { 
                  sh "gradle ${OUTPUT_VERBOSITY} -Dgradle.user.home=${workspace}/.gradle ${GRADLE_TASKS}"
               }
            }
         }
      }
   }
}